<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Draw a Digit</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="bg-gray-900 flex flex-col items-center justify-center min-h-screen text-white"
  >
    <h1 class="text-2xl font-bold mb-4">Draw a Digit</h1>

    <canvas
      id="canvas"
      width="280"
      height="280"
      class="border-2 border-white bg-black"
    ></canvas>

    <div class="mt-4 flex gap-4">
      <button onclick="clearCanvas()" class="px-4 py-2 bg-red-500 rounded">
        Clear
      </button>
      <button onclick="predictDigit()" class="px-4 py-2 bg-green-500 rounded">
        Predict
      </button>
    </div>

    <p id="result" class="mt-4 text-lg"></p>

    <script>
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      let drawing = false;
      ctx.lineWidth = 20;
      ctx.lineCap = "round";
      ctx.strokeStyle = "white";

      canvas.addEventListener("mousedown", () => (drawing = true));
      canvas.addEventListener(
        "mouseup",
        () => ((drawing = false), ctx.beginPath())
      );
      canvas.addEventListener("mousemove", draw);

      function draw(e) {
        if (!drawing) return;
        ctx.lineTo(e.offsetX, e.offsetY);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(e.offsetX, e.offsetY);
      }

      function clearCanvas() {
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      async function predictDigit() {
        const dataURL = canvas.toDataURL("image/png");
        const res = await fetch("http://127.0.0.1:5000/predict", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: dataURL }),
        });
        const json = await res.json();
        document.getElementById(
          "result"
        ).innerText = `Prediction: ${json.prediction}`;
        if (json.top3) {
          document.getElementById("result").innerText += `, top3: ${json.top3
            .map((p) => p.label + " (" + (p.prob * 100).toFixed(1) + "%)")
            .join(", ")}`;
        }
        document.getElementById("debug").src = json.processed_image;
      }

      clearCanvas();
    </script>
  </body>
</html>
